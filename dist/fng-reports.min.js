/*! forms-angular 2014-06-08 */
"use strict";function ngGridCsvExportPlugin(a){var b=this;b.grid=null,b.scope=null,b.init=function(c,d){function e(){var a=angular.element("h1").parent(),c=angular.element("#csv-data-link");null!=c&&c.remove();var d='<button id="csv-data-link" class="btn"><a href="data:text/csv;charset=UTF-8,';d+=encodeURIComponent(b.prepareCSV()),d+='" download="Export.csv">CSV Export</button>',a.append(d)}b.grid=d,b.scope=c,a.inhibitButton||(setTimeout(e,0),c.catHashKeys=function(){var a="";for(var b in c.renderedRows)a+=c.renderedRows[b].$$hashKey;return a},c.$watch("catHashKeys()",e))},b.createCSV=function(){window.open("data:text/csv;charset=UTF-8,"+encodeURIComponent(b.prepareCSV()))},b.prepareCSV=function(){function a(a){return null==a?"":"number"==typeof a?""+a:"boolean"==typeof a?a?"TRUE":"FALSE":"string"==typeof a?a.replace(/"/g,'""'):JSON.stringify(a).replace(/"/g,'""')}function c(a){var b=a.substr(0,a.length-1);return b+"\n"}var d="";return angular.forEach(b.scope.columns,function(b){b.visible&&(void 0===b.width||b.width>0)&&(d+='"'+a(b.displayName)+'",')}),d=c(d),angular.forEach(b.grid.filteredRows,function(e){angular.forEach(b.scope.columns,function(b){b.visible&&(d+='"'+a(e.entity[b.field])+'",')}),d=c(d)}),d}}function ngGridPdfExportPlugin(a){var b=this;b.grid=null,b.scope=null,b.services=null,b.options=a,b.init=function(c,d,e){if(b.grid=d,b.scope=c,b.services=e,!a.inhibitButton){var f=d.$root.find(".ngFooterPanel"),g=d.$root.find(".ngFooterPanel .pdf-data-link-span");null!=g&&g.remove();var h='<button class="pdf-data-link-span">PDF Export</button>';f.append(h),f.on("click",function(){b.createPDF()})}},b.createPDF=function(){var a=[],c=[],d={},e=b.scope.totalRowWidth(),f=15;angular.forEach(b.scope.columns,function(c){c.visible&&(void 0===c.width||c.width>0)&&(a.push({name:c.field,prompt:c.displayName,width:c.width*(185/e),align:c.colDef.align||"left"}),c.colDef.totalsRow&&(d[c.field]=b.scope.getTotalVal(c.field,c.filter).toString()))}),angular.forEach(b.grid.filteredRows,function(a){c.push(angular.copy(a.entity))});var g=new jsPDF("landscape","mm","a4");g.setFontStyle("bold"),g.setFontSize(24),g.text(b.scope.reportSchema.title,f,f),g.setFontStyle("normal"),g.setFontSize(12),g.cellInitialize(),g.table(f,24,c,{headers:a,footers:d,printHeaders:!0,autoSize:!1,margins:{left:f,top:f,bottom:f,width:g.internal.pageSize-f}}),g.output("dataurlnewwindow")}}formsAngular.controller("AnalysisCtrl",["$locationParse","$filter","$scope","$http","$location","$routeParams","urlService",function(a,b,c,d,e,f,g){var h=!0,i=new ngGridPdfExportPlugin({inhibitButton:!0}),j=new ngGridCsvExportPlugin({inhibitButton:!0});if(angular.extend(c,f),c.reportSchema={},c.gridOptions={columnDefs:"reportSchema.columnDefs",data:"report",showColumnMenu:!0,showFilter:!0,showFooter:!0,reallyShowFooter:!0,showTotals:!0,enableColumnResize:!0,footerRowHeight:65,multiSelect:!1,plugins:[i,j],afterSelectionChange:function(a){var b=c.reportSchema.drilldown;b&&(b=g.buildUrl(b.replace(/\|.+?\|/g,function(b){var d=b.slice(1,-1),e=/\((.+)\)/.exec(d);return e?c.reportSchema.params[e[1]].value:a.entity[d]})),window.location=b)},footerTemplate:'<div ng-show="gridOptions.reallyShowFooter" class="ngFooterPanel" ng-class="{\'ui-widget-content\': jqueryUITheme, \'ui-corner-bottom\': jqueryUITheme}" ng-style="footerStyle()"><div ng-show="gridOptions.showTotals" ng-style="{height: rowHeight+3}"><div ng-style="{ \'cursor\': row.cursor }" ng-repeat="col in renderedColumns" ng-class="col.colIndex()" class="ngCell ngTotalCell {{col.cellClass}}"><div class="ngVerticalBar" ng-style="{height: rowHeight}" ng-class="{ ngVerticalBarVisible: !$last }">&nbsp;</div><div ng-total-cell></div> </div></div><div class="ngTotalSelectContainer" ><div class="ngFooterTotalItems" ng-class="{\'ngNoMultiSelect\': !multiSelect}" ><span class="ngLabel">{{i18n.ngTotalItemsLabel}} {{maxRows()}}</span><span ng-show="filterText.length > 0" class="ngLabel">({{i18n.ngShowingItemsLabel}} {{totalFilteredItemsLength()}})</span></div><div class="ngFooterSelectedItems" ng-show="multiSelect">  <span class="ngLabel">{{i18n.ngSelectedItemsLabel}} {{selectedItems.length}}</span></div></div><div class="ngPagerContainer" style="float: right; margin-top: 10px;" ng-show="enablePaging" ng-class="{\'ngNoMultiSelect\': !multiSelect}"><div style="float:left; margin-right: 10px;" class="ngRowCountPicker"><span style="float: left; margin-top: 3px;" class="ngLabel">{{i18n.ngPageSizeLabel}}</span><select style="float: left;height: 27px; width: 100px" ng-model="pagingOptions.pageSize" ><option ng-repeat="size in pagingOptions.pageSizes">{{size}}</option></select></div><div style="float:left; margin-right: 10px; line-height:25px;" class="ngPagerControl" style="float: left; min-width: 135px;"><button class="ngPagerButton" ng-click="pageToFirst()" ng-disabled="cantPageBackward()" title="{{i18n.ngPagerFirstTitle}}"><div class="ngPagerFirstTriangle"><div class="ngPagerFirstBar"></div></div></button><button class="ngPagerButton" ng-click="pageBackward()" ng-disabled="cantPageBackward()" title="{{i18n.ngPagerPrevTitle}}"><div class="ngPagerFirstTriangle ngPagerPrevTriangle"></div></button><input class="ngPagerCurrent" min="1" max="{{maxPages()}}" type="number" style="width:50px; height: 24px; margin-top: 1px; padding: 0 4px;" ng-model="pagingOptions.currentPage"/><button class="ngPagerButton" ng-click="pageForward()" ng-disabled="cantPageForward()" title="{{i18n.ngPagerNextTitle}}"><div class="ngPagerLastTriangle ngPagerNextTriangle"></div></button><button class="ngPagerButton" ng-click="pageToLast()" ng-disabled="cantPageToLast()" title="{{i18n.ngPagerLastTitle}}"><div class="ngPagerLastTriangle"><div class="ngPagerLastBar"></div></div></button></div></div></div>'},c.report=[],!c.reportSchemaName&&f.r)switch(f.r.slice(0,1)){case"[":c.reportSchema.pipeline=JSON.parse(f.r);break;case"{":angular.extend(c.reportSchema,JSON.parse(f.r));break;default:throw new Error("No report instructions specified")}c.getTotalVal=function(a,d){var e="",f=_.find(c.reportSchema.columnDefs,function(b){return b.field===a});if(f)switch(f.totalsRow){case void 0:break;case"$SUM":for(var g=0,h=0;h<c.report.length;h++)g+=c.report[h][a];e=g,d&&(e=b(d)(e));break;default:e=f.totalsRow}return e},c.$on("exportToPDF",function(){i.createPDF()}),c.$on("exportToCSV",function(){j.createCSV()}),c.refreshQuery=function(){var a="/api/report/"+c.model,f="?";if(c.reportSchemaName&&(a+="/"+c.reportSchemaName),c.paramSchema){for(var g in c.record)if(c.record.hasOwnProperty(g)){var i=c.reportSchema.params[g];if(c.record[g]&&""!==c.record[g])c.param=c.record[g],i.conversionExpression&&(c.param=c.$eval(i.conversionExpression)),a+=f+g+"="+c.param,f="&";else if(i.required)return}}else{var j=e.$$url.match(/\?.*/);j&&(a+=f+j[0].slice(1))}d.get(a).success(function(a){if(a.success){if(c.report=a.report,c.reportSchema=a.schema,c.reportSchema.title=c.reportSchema.title||c.model,h&&(h=!1,c.$watch("reportSchema.columnDefs",function(a){var b=!1;if(a)for(var d=0;d<a.length;d++)if(a[d].totalsRow&&(b=!0),a[d].align){var e="fng-"+a[d].align;a[d].cellClass=a[d].cellClass||"",-1===a[d].cellClass.indexOf(e)&&(a[d].cellClass=a[d].cellClass+" "+e)}c.gridOptions.showTotals=b,c.gridOptions.reallyShowFooter=b,c.gridOptions.footerRowHeight=55+(b?10:0)},!0),!c.paramSchema&&a.schema.params)){c.paramSchema=[],c.record={};for(var d in a.schema.params)if(a.schema.params.hasOwnProperty(d)){var e=a.schema.params[d];if(!e.noInput){var f=c.paramSchema.push({name:d,id:"fp_"+d,label:e.label||b("titleCase")(d),type:e.type||"text",required:!0,add:e.add||void 0,size:e.size||"small"});"select"===e.type&&(c[d+"_Opts"]=e.enum,c.paramSchema[f-1].options=d+"_Opts")}var g=/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3})(Z|[+ -]\d{4})$/.exec(e.value);g&&(e.value=moment(g[1]).format("YYYY-MM-DDTHH:mm:ss.SSS")+"Z"),c.record[d]=e.value}c.$watch("record",function(a,b){b!==a&&c.refreshQuery()},!0)}}else console.log(JSON.stringify(a)),c.reportSchema.title="Error - see console log"}).error(function(a){console.log(JSON.stringify(a)),e.path("/404")})},c.refreshQuery()}]);